import streamlit as st
import joblib
import numpy as np
import pandas as pd
import warnings
warnings.simplefilter("ignore")

# ----------------------------------------
# ğŸ’¡  App Configuration & Theme Settings
# ----------------------------------------
st.set_page_config(
    page_title="Driver Churn Prediction",
    page_icon="ğŸš—",
    layout="centered",
    initial_sidebar_state="expanded"
)

# ----------------------------------------
# ğŸš€ Load the Model and Scaler using joblib
# ----------------------------------------
@st.cache_resource
def load_models():
    scaler = joblib.load('models/scaler.pkl')
    rf_model = joblib.load('models/rf_model.pkl')
    return scaler, rf_model


scaler, rf_model = load_models()

# ----------------------------------------
# ğŸ† App Title & Description
# ----------------------------------------
st.title("ğŸš— Driver Churn Prediction")
st.markdown("### Predict whether a driver is at risk of **churning** based on their profile.")
st.markdown("---")

# ----------------------------------------
# ğŸ“ User Input Form
# ----------------------------------------
with st.form("driver_form", clear_on_submit=False):
    col1, col2 = st.columns(2)

    with col1:
        age = st.number_input("ğŸ§‘ Age (years)", min_value=18, max_value=100, step=1, help="Driver's age")
        income = st.number_input("ğŸ’° Income (â‚¹)", min_value=1000, max_value=1000000, step=1000,
                                 help="Driver's monthly income")
        total_business_value = st.number_input("ğŸ“Š Total Business Value (â‚¹)",
                                               step=1000, help="Total revenue generated by the driver")
        joining_designation = st.selectbox("ğŸ“Œ Joining Designation", [1, 2, 3, 4, 5], help="Initial role when joining")
        last_quarterly_rating = st.selectbox("â­ Last Quarterly Rating", [1, 2, 3, 4, 5],
                                             help="Performance rating in last quarter")

    with col2:
        gender = st.selectbox("âš§ Gender", ["Male", "Female"], help="Select driver's gender")
        education = st.selectbox("ğŸ“ Education Level", ["10+", "12+", "Graduate"],
                                 help="Highest education level attained")
        grade = st.selectbox("ğŸ† Grade", [1, 2, 3, 4, 5], help="Current driver grade")
        quarterly_rating_increased = st.selectbox("ğŸ“ˆ Quarterly Rating Increased?", ["Yes", "No"],
                                                  help="Did rating improve last quarter?")
        salary_increased = st.selectbox("ğŸ“‰ Salary Increased?", ["Yes", "No"], help="Did salary increase recently?")

    # Submit Button
    submit_button = st.form_submit_button("ğŸ”® Predict Churn Probability")

# ----------------------------------------
# ğŸ” Process Inputs & Make Predictions
# ----------------------------------------
if submit_button:
    # Convert categorical inputs
    gender = 0 if gender == "Male" else 1
    education_mapping = {"10+": 0, "12+": 1, "Graduate": 2}
    education = education_mapping[education]
    quarterly_rating_increased = 1 if quarterly_rating_increased == "Yes" else 0
    salary_increased = 1 if salary_increased == "Yes" else 0

    # Prepare input array
    user_input = np.array([[age, gender, education, income, joining_designation, grade,
                            total_business_value, last_quarterly_rating, quarterly_rating_increased, salary_increased]])

    # Define feature names (MUST match the names used during training)
    # Define feature names in the exact order as used during training
    feature_columns = [
        "Age", "Gender", "Education", "Income", "Joining_Designation",
        "Grade", "Total_Business_Value", "Last_Quarterly_Rating",
        "Quarterly_Rating_Increased", "Salary_Increased"
    ]

    # Convert user input into a DataFrame (ensuring correct feature names)
    user_input_df = pd.DataFrame(user_input, columns=feature_columns)

    # Ensure all columns match the training data exactly
    user_input_df = user_input_df[feature_columns]  # Ensures correct column order

    # Scale the input
    user_input_scaled = scaler.transform(user_input_df)

    # Predict churn probability
    churn_prob = rf_model.predict_proba(user_input_scaled)[:, 1][0]

    # ----------------------------------------
    # ğŸ¯ Display Results
    # ----------------------------------------
    st.markdown("---")
    st.markdown("### ğŸ”® **Churn Probability**")

    if churn_prob > 0.6:
        st.markdown(f'<div class="churn-high" style="font-size: 24px;">âš ï¸ High Churn Risk! ({churn_prob:.2%})</div>', unsafe_allow_html=True)
        st.warning(f"The driver has a **{churn_prob:.2%} probability** of churning. Consider retention strategies.")
    elif churn_prob > 0.4:
        st.markdown(f'<div class="churn-high" style="font-size: 24px;">ğŸŸ  Medium Churn Risk! ({churn_prob:.2%})</div>', unsafe_allow_html=True)
        st.warning(f"The driver has a **{churn_prob:.2%} probability** of churning. Consider retention strategies.")
    else:
        st.markdown(f'<div class="churn-low" style="font-size: 24px;">âœ”ï¸ Low Churn Risk ({churn_prob:.2%})</div>', unsafe_allow_html=True)
        st.success(f"The driver has a **{churn_prob:.2%} probability** of staying. No major risk detected.")

    st.markdown("---")
